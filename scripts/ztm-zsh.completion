#compdef ztm bin/ztm

_ztm_meshes() {
  local -a meshes
  meshes=($(ztm get mesh | awk 'NR>1 {print $1}'))
  _describe -t meshes 'meshes' meshes
}

_ztm_eps() {
  local -a eps
  local mesh_ctx=""
  
  # Check if we are in a mesh context
  if [[ "${words[1]}" == "mesh" && -n "${words[2]}" ]]; then
     mesh_ctx="mesh ${words[2]}"
  fi

  # We use 'eval' to properly expand mesh_ctx if it's set
  eps=($(eval "ztm $mesh_ctx get ep" | awk 'NR>1 {print $1}'))
  _describe -t endpoints 'endpoints' eps
}

_ztm_completion() {
  local -a main_commands
  main_commands=(
    'mesh:Execute command in specific mesh'
    'ep:Execute command on specific endpoint'
    'version:Print ZTM version information'
    'completion:Generate shell completion script'
    'config:View or set CLI configuration'
    'ca:Export or import the CA certificate'
    'root:Generate a permit for the root user'
    'identity:Print the identity of the current running agent'
    'label:View or change labels of an endpoint'
    'start:Start running a hub, agent or app as background service'
    'stop:Stop running a hub, agent or app as background service'
    'run:Start running a hub or agent in foreground mode'
    'invite:Issue a permit to a user for joining the mesh'
    'evict:Revoke a permit and block the user from joining the mesh'
    'join:Join a mesh'
    'leave:Leave a mesh'
    'enable:Enable a mesh or app'
    'disable:Disable a mesh or app'
    'attach:Attach to a specified hub'
    'get:List objects of a certain type'
    'describe:View detailed information about an object'
    'download:Download an app or file from the mesh'
    'erase:Erase a downloaded app or file'
    'publish:Publish an app or file to the mesh'
    'unpublish:Unpublish an app or file from the mesh'
    'log:View logs from an app or endpoint'
    'stats:View stats of endpoints'
    'ping:Send a ping to an endpoint'
    'help:Display help information'
  )

  local -a apps
  apps=(
    'chat:Messaging between mesh endpoints'
    'cloud:Manage mesh cloud storage'
    'file:Interact with distributed files'
    'llm:Access mesh LLM services'
    'port:Manage port mappings'
    'proxy:Configure proxying rules'
    'script:Run remote scripts'
    'terminal:Open remote terminal sessions'
    'tunnel:Configure mesh tunnels'
    'users:Manage mesh users'
  )

  local -a commands
  commands=( $main_commands $apps )

  local context state state_descr line
  typeset -A opt_args

  _arguments -C \
    '1:command:->command' \
    '*::argument:->args'

  case $state in
    command)
      _describe -t commands 'ztm commands' commands
      ;;
    args)
      local cmd="${words[1]}"
      
      # Handle 'mesh' context
      if [[ "$cmd" == "mesh" ]]; then
         if (( CURRENT == 2 )); then
            _ztm_meshes
            return
         elif (( CURRENT == 3 )); then
            _describe -t commands 'ztm commands' commands
            return
         else
            # Shift context: words[3] is the real command
            cmd="${words[3]}"
            # Adjust words array to simulate normal command
            # This is tricky in Zsh _arguments state machine
            # We will manually dispatch based on 'cmd'
            # Note: CURRENT index is still relative to full line
            # We need to map relative position
            local relative_current=$(( CURRENT - 2 ))
            
            # Re-implement dispatch logic for sub-commands
            case "$cmd" in
              get)
                 if (( relative_current == 2 )); then
                   _values 'object type' mesh hub app file ep
                 fi
                 ;;
              tunnel)
                 if (( relative_current == 2 )); then
                   _values 'tunnel command' get describe open close help
                 elif (( relative_current == 3 )); then
                   case "${words[4]}" in
                     open)
                        _values 'tunnel object' inbound outbound
                        ;;
                     get|describe|close)
                        _values 'tunnel object' tunnel inbound outbound
                        ;;
                   esac
                 fi
                 ;;
              # ... other commands ...
              start|stop|run|enable|disable|log|stats|ping|describe|download|erase|publish|unpublish)
                 if (( relative_current == 2 )); then
                   _values 'object type' mesh hub agent app file endpoint ep
                 fi
                 ;;
            esac
            return
         fi
      fi

      # Handle 'ep' context
      if [[ "$cmd" == "ep" || "$cmd" == "endpoint" ]]; then
         if (( CURRENT == 2 )); then
            _ztm_eps
            return
         elif (( CURRENT == 3 )); then
            _describe -t commands 'ztm commands' commands
            return
         else
            cmd="${words[3]}"
            local relative_current=$(( CURRENT - 2 ))
            case "$cmd" in
              get)
                 if (( relative_current == 2 )); then
                   _values 'object type' mesh hub app file ep
                 fi
                 ;;
              tunnel)
                 if (( relative_current == 2 )); then
                   _values 'tunnel command' get describe open close help
                 elif (( relative_current == 3 )); then
                   case "${words[4]}" in
                     open)
                        _values 'tunnel object' inbound outbound
                        ;;
                     get|describe|close)
                        _values 'tunnel object' tunnel inbound outbound
                        ;;
                   esac
                 fi
                 ;;
              start|stop|run|enable|disable|log|stats|ping|describe|download|erase|publish|unpublish)
                 if (( relative_current == 2 )); then
                   _values 'object type' mesh hub agent app file endpoint ep
                 fi
                 ;;
            esac
            return
         fi
      fi

      case "$cmd" in
        completion)
          _values 'shell' bash zsh
          ;;
        ca)
          _values 'operation' import export
          ;;
        tunnel)
          if (( CURRENT == 2 )); then
            _values 'tunnel command' get describe open close help
          elif (( CURRENT == 3 )); then
            case "${words[2]}" in
              open)
                 _values 'tunnel object' inbound outbound
                 ;;
              get|describe|close)
                 _values 'tunnel object' tunnel inbound outbound
                 ;;
            esac
          fi
          ;;
        get)
          if (( CURRENT == 2 )); then
            _values 'object type' mesh hub app file ep
          fi
          ;;
        start|stop|run|enable|disable|log|stats|ping|describe|download|erase|publish|unpublish)
          if (( CURRENT == 2 )); then
            _values 'object type' mesh hub agent app file endpoint ep
          fi
          ;;
      esac
      ;;
  esac
}

if [[ -n ${ZSH_VERSION-} ]]; then
  compdef _ztm_completion ztm bin/ztm
fi
